# Java UT Agent 继续改进计划

## 剩余问题分析
基于 SpotBugs 分析，还存在 63 个问题需要修复，包括：

### 高优先级问题
1. **默认编码依赖** - IterativeOptimizer 中使用 FileWriter 时未指定编码

### 中优先级问题
1. **空指针风险** - LLMClient 和 AbstractLLMProvider 中可能的空指针
2. **内部表示暴露** - 多个模型类和内部类返回可变集合
3. **格式字符串问题** - 使用 \n 而非 %n
4. **未使用字段** - CLICommand 等类中的未使用字段
5. **死存储问题** - SpringMvcTestStrategy 中的死变量
6. **缺少 switch default** - JacocoXmlParser 中缺少默认分支

## 改进计划

### Phase 1: 修复高优先级问题
1. **修复 IterativeOptimizer 默认编码问题**
   - 将 FileWriter 替换为使用 StandardCharsets.UTF_8 的 Files.writeString

### Phase 2: 修复空指针风险问题
1. **修复 LLMClient.chat 方法**
   - 在调用 getChatResponse 后添加空值检查

2. **修复 AbstractLLMProvider.chat 方法**
   - 在处理响应时添加空值检查

### Phase 3: 修复内部表示暴露问题
1. **修复模型类** (AnnotationInfo, ClassInfo, CoverageReport, FieldInfo, MethodInfo)
   - 由于是 record 类，考虑创建不可变包装或使用防御性拷贝

2. **修复内部类** (FileCoverageDiff, IncrementalCoverageResult, ChangeInfo)
   - 在构造函数中创建集合副本，返回不可变视图

3. **修复其他类** (MetricsManager, CachedLLMProvider, ProgressBar, StatisticsPanel)
   - 应用适当的不可变处理

### Phase 4: 修复其他问题
1. **修复格式字符串问题**
   - 将所有 \n 替换为 %n

2. **修复未使用字段**
   - 删除或使用 CLICommand.stream 字段

3. **修复死存储问题**
   - 删除 SpringMvcTestStrategy 中的死变量

4. **修复缺少 switch default**
   - 在 JacocoXmlParser 中添加 default 分支

### Phase 5: 验证修复
1. 运行 `mvn spotbugs:check` 确保所有问题已修复
2. 运行 `mvn test` 确保所有测试通过

## 预期结果
- 消除所有 63 个 SpotBugs 警告
- 保持所有 226 个测试通过
- 提高代码质量和可维护性