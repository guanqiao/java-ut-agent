# 增量UT生成功能实现计划

## 目标
支持增量添加UT，充分利用已有的测试代码，避免每次完全重新生成。

## 实现步骤

### Phase 1: 测试文件解析器
**新建文件**: `src/main/java/com/utagent/parser/TestFileParser.java`
- 解析已有测试文件，提取测试方法信息
- 识别测试方法名称、被测试的方法、使用的注解
- 返回 `ParsedTestFile` 对象，包含所有测试方法信息

**新建模型**: `src/main/java/com/utagent/model/ParsedTestMethod.java`
- 测试方法名、被测试方法名、注解列表、测试代码

**新建模型**: `src/main/java/com/utagent/model/ParsedTestFile.java`
- 测试类名、包名、导入列表、测试方法列表

### Phase 2: 增量测试生成器
**新建文件**: `src/main/java/com/utagent/generator/IncrementalTestGenerator.java`
- 检测已存在的测试文件
- 分析已有测试覆盖的方法
- 生成仅针对未覆盖方法的测试
- 合并新旧测试代码

### Phase 3: PromptBuilder 增强
**修改文件**: `src/main/java/com/utagent/generator/llm/PromptBuilder.java`
- 新增 `buildIncrementalTestPrompt()` 方法
- 在prompt中包含已有测试信息，避免重复生成
- 支持指定需要新增测试的方法

### Phase 4: TestGenerator 增强
**修改文件**: `src/main/java/com/utagent/generator/TestGenerator.java`
- 新增 `generateIncrementalTests()` 方法
- 支持传入已有测试信息
- 生成增量测试代码

### Phase 5: IterativeOptimizer 增强
**修改文件**: `src/main/java/com/utagent/optimizer/IterativeOptimizer.java`
- 修改 `optimize()` 方法支持增量模式
- 新增 `optimizeIncremental()` 方法
- 检测已存在测试文件并解析
- 合并新旧测试代码

### Phase 6: CLI 支持
**修改文件**: `src/main/java/com/utagent/cli/CLICommand.java`
- 新增 `--incremental` / `-I` 命令行参数
- 新增 `--force` 参数强制完全重新生成

### Phase 7: 配置支持
**修改文件**: `src/main/java/com/utagent/config/GenerationConfig.java`
- 新增 `incremental` 配置项
- 新增 `preserveExistingTests` 配置项

### Phase 8: 单元测试
- `TestFileParserTest.java`
- `IncrementalTestGeneratorTest.java`
- 更新 `IterativeOptimizerTest.java`

## 关键设计决策

1. **智能合并策略**：
   - 保留已有测试方法
   - 只添加新的测试方法
   - 避免重复生成相同方法的测试

2. **覆盖率驱动**：
   - 分析已有测试的覆盖率
   - 只针对未覆盖代码生成新测试

3. **安全覆盖**：
   - 提供 `--force` 参数强制完全重新生成
   - 默认使用增量模式